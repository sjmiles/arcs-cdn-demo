<!doctype html>
<html lang="en">
<head>

  <title>Arcs: CDN Demo</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

  <link rel="stylesheet" href="index.css">

  <!-- Arcs engine -->
  <script src="//localhost/projects/arcs/arcs/runtime/browser/build/cdn/ArcsLib.js"></script>

  <!-- demo helpers -->
  <script src="recipes.js"></script>
  <script src="data-context.js"></script>
  <script src="utils.js"></script>

  <!-- custom elements -->
  <script src="lib/x-toast.js"></script>
  <script src="lib/suggestions-element.js"></script>

</head>
<body>

  <demo-frame>
    <div id="particle-container"></div>
    <suggestions-element></suggestions-element>
  </demo-frame>

  <script>
    (async function() {
      //
      // 1. URL mapping
      //
      // paths
      let root = `https://sjmiles.github.io/arcs-cdn/v0.01`;
      let local = `${root}/runtime/browser/`;
      // setup default map
      let map = utils.createUrlMap(root);
      // overrides
      Object.assign(map, {
        //'worker-entry-cdn.js': `${root}/build/cdn/worker-entry-cdn.js`,
        //'assets': `${local}/assets`,
        //'../assets': `${local}/assets`,
        '/': '/'
      });
      /*
      let map = {};
      // TODO(sjmiles): map must contain (explicitly, no prefixing) a mapping for `worker-entry-cdn.js`
      map['worker-entry-cdn.js'] = `${local}/build/cdn/worker-entry-cdn.js`
      */

      //
      // Step 2: create system objects
      // rendering system
      let slotComposer = new Arcs.SlotComposer(window['particle-container'], /* affordance */ "dom");
      // an Arc!
      let arc = Arcs.createArc({id: 'demo', urlMap: map, slotComposer});

      //
      // Step 3: setup your app
      //
      // load manifest
      let manifest = await Arcs.Manifest.load('./demo.manifest', arc._loader);
      // setup the database
      prepareDataContext(arc, manifest);
      // suggestion engine
      let planner = new Arcs.Planner();
      // configure suggestions UI
      let suggestionsUI = document.querySelector('suggestions-element');
      suggestionsUI.arc = arc;
      suggestionsUI.callback = () => {};
      // feed suggestions UI
      //utils.suggest(arc, planner, suggestions, recipes);
      // TODO: Shrug.. Context dependency between demo base and subclasses is weird.
      let context = {
        arc,
        recipes: manifest.recipes
      };
      //context.recipes = this.stage.recipes;
      planner.init(arc, context);
      let suggestions = await planner.suggest(500);
      suggestions.forEach((suggestion, i) => {
        suggestionsUI.add(suggestion, i);
      });
    })();
  </script>

</body>
</html>